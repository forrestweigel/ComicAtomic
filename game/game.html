<!DOCTYPE html>
<html>
<head>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.15.1/dist/phaser-arcade-physics.min.js"></script>
</head>
<body>

    <script>

    var config = {
        type: Phaser.AUTO,
        width: 1000,
        height: 720,
        cardW: 375,
        cardH: 562.5,
        cardS: 0.21,
        scene: {
            preload: preload,
            create: create
        }
    };

    var game = new Phaser.Game(config);

    function preload ()
    {
        this.load.spritesheet("FFDeck", "/ComicAtomic/img/FFDeck.png", {frameWidth: config.cardW, frameHeight: config.cardH});
        this.load.spritesheet("MMDeck", "/ComicAtomic/img/MMDeck.png", {frameWidth: config.cardW, frameHeight: config.cardH});
        this.load.image('board', '/ComicAtomic/img/board2.png'); 
        this.load.image('FFLogo', '/ComicAtomic/img/FFLogo.png');
        this.load.image('MMLogo', '/ComicAtomic/img/MMLogo.png');
        this.load.image('logo', '/ComicAtomic/img/logo.png'); 
    }

    function create ()
    {
        this.p1 = null;
        this.p2 = null;
        this.input.mouse.disableContextMenu();

        pickFaction(this);

        this.deck = Phaser.Utils.Array.NumberArray(6,33);
        this.hand = Array();
        this.energy = 0;

        this.die1 = this.add.text(930, 100, '','Arial, 80, , , , , white');
        this.die2 = this.add.text(930, 125, '','Arial, 80, , , , , white');
        this.die3 = this.add.text(930, 150, '','Arial, 80, , , , , white');
        this.die4 = this.add.text(930, 175, '','Arial, 80, , , , , white');
       
        this.board = 
        [
            [0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0],
        ]

        for(x = 0; x < 6; x++)
        {
            for(y = 0; y < 8; y++)
            {
                this.board[x][y] = null;
            }
        }

        for(x = 0; x < 5; x++)
        {
           this.hand[x] = null;
        }

        Phaser.Utils.Array.Shuffle(this.deck);
        this.cardIdx = 0;

        var conn = new WebSocket('ws://localhost:1337');

        conn.onopen = function(e) 
        {
            console.log("connection established!");
        }

        conn.onmessage = function(e) 
        {       
            var msg = JSON.parse(e.data);
            
            boardUpdateRecieve(msg, this);
        };
    }

    function runGame(game)
    {
        game.discard = game.add.text(930, 650, '$','Arial, 80, , , , , white');
        game.bk = game.add.image(500,360,'board');
        fillHand(game);
        setUp(game);
        endTurnBtn(game);
        rollButton(game)
        movement(game);
    }

    function pickFaction(game)
    {
        var facImg1 = game.add.image(0,0, "FFLogo").setScale(.5);
        var facBtn1 = game.add.container(300,350, [ facImg1 ]);

        facBtn1.setSize(facImg1.width * .5, facImg1.height * .5);

        facBtn1.setInteractive();
        
        facBtn1.on('pointerover', function () 
        {
            facImg1.setTint(0x7878ff);
        });

        facBtn1.on('pointerout', function () 
        {
            facImg1.clearTint();
        });

        facBtn1.on("pointerdown", function()
        {
            console.log("wherein")
            game.p1 = "FFDeck";
            game.p2 = "MMDeck";
            facBtn1.destroy();
            facBtn2.destroy();
            runGame(game)
        });


        var facImg2 = game.add.image(0,0, "MMLogo").setScale(.5);
        var facBtn2 = game.add.container(700,350, [ facImg2 ]);

        facBtn2.setSize(facImg2.width * .5, facImg2.height * .5);

        facBtn2.setInteractive();
        
        facBtn2.on('pointerover', function () 
        {
            facImg2.setTint(0x7878ff);
        });

        facBtn2.on('pointerout', function () 
        {
            facImg2.clearTint();
        });

        facBtn2.on("pointerdown", function()
        {
            console.log("wherein")
            game.p2 = "FFDeck";
            game.p1 = "MMDeck";
            facBtn1.destroy();
            facBtn2.destroy();
            runGame(game)
        });
    }

    function movement(game)
    {
        game.input.on('drag', function (pointer, gameObject, dragX, dragY) {

        gameObject.x = dragX;
        gameObject.y = dragY;
        });

        game.input.on('dragend', function (pointer, gameObject)
        {
        if(checkOverlap(gameObject, game.discard) && gameObject.placed == false)
        {
            gameObject.destroy();
            game.hand[gameObject.val] = null;
            game.energy += 1;
            game.discard.text = game.energy;
                
            x = Math.round((originX) / 120);
            y = Math.round((originY) / 79);
            game.board[x - 2][y - 1] = null;

            var msg = "one";
            conn.send(JSON.stringify(msg));

        }

        else if(!checkOverlap(gameObject, game.bk))
        {
            gameObject.x = originX;
            gameObject.y = originY;
        }

        else 
        {
            game.hand[gameObject.val] = null;
            var x = Math.round((gameObject.x) / 120);
            var y = Math.round((gameObject.y) / 79);

            if(game.board[x - 2][y - 1] == null)
            {
                game.board[x - 2][y - 1] = gameObject;
                gameObject.x = 120 * x - 40;
                gameObject.y = 79 * y + 4;
                
                x = Math.round((originX) / 120);
                y = Math.round((originY) / 79);

                if(gameObject.placed == true)
                {
                    game.board[x - 2][y - 1] = null;
                }
                
                gameObject.placed = true;

                var msg = "one";
                conn.send(JSON.stringify(msg));
            }

            else
            {        
                gameObject.x = originX;
                gameObject.y = originY;
            }
        }
        });

        game.input.on('dragstart', function (pointer, gameObject)
        {
            originX = gameObject.x;
            originY = gameObject.y;
        });

        game.input.on('gameobjectdown', function (pointer, gameObject)
        {
            if(pointer.rightButtonDown())
            {
                console.log(gameObject.name)
                gameObject.health--;

                if(gameObject.health == 0)
                {
                    gameObject.destroy();
                    game.energy += 1;
                    game.discard.text = game.energy;
                        
                    x = Math.round((originX) / 120);
                    y = Math.round((originY) / 79);
                    game.board[x - 2][y -1] = null;
                }
            }
        });
    }

    function setUp(game)
    {
        var num;
        var x;
        var y;

        for(i = 0; i < 6; i++)
        {
            x = Math.floor(Math.random() * 5) + 2;
            y = Math.floor(Math.random() * 4) + 5;

            var card = game.add.image(0, 0, game.p1, i);
            card.setScale(config.cardS);
            card.angle += -90;

            var set = game.add.container((120 * x) - 40, (79 * y) + 4, [ card ]);
            
            set.name = i;
            set.placed = true;
            set.health = 2;

            set.setSize(card.width * config.cardS, card.height * config.cardS);

            set.setInteractive();
            game.board[x - 2][y - 1] = set;

            game.input.setDraggable(set);
        }
    }

    function fillHand(game)
    {
        for(x = 0; x < 5; x++)
        {
            if(game.hand[x] == null)
            {
                console.log(game.p1)
                var card = game.add.image(0, 0, game.p1, game.deck[game.cardIdx]);
                var originX = 0;
                var originY = 0;
                card.setScale(config.cardS);
                card.angle += -90;

                game.hand[x] = game.add.container(70, 290 + (90 * x), [ card ]);
                
                game.hand[x].name = game.deck[game.cardIdx];
                game.hand[x].val = x;
                game.hand[x].placed = false;
                game.hand[x].health = 2;
                game.cardIdx++;

                game.hand[x].setSize(card.width * config.cardS, card.height * config.cardS);

                game.hand[x].setInteractive();

                game.input.setDraggable(game.hand[x]);
            }
        }   
    }

    function checkOverlap(sp1, sp2)
    {
        var bounds1 = sp1.getBounds();
        var bounds2 = sp2.getBounds();   

        return Phaser.Geom.Intersects.RectangleToRectangle(bounds1, bounds2);
    }

    function endTurnBtn(game)
    {    
        var sprite = game.add.image(0, 0, 'logo').setScale(.1);
        var endBtn = game.add.container(930, 613, [ sprite ]);
            
        endBtn.setSize(sprite.width * .1, sprite.height * .1);

        endBtn.setInteractive();

        endBtn.on('pointerover', function () {

            sprite.setTint(0x7878ff);

        });

        endBtn.on('pointerout', function () {

            sprite.clearTint();

        });

        endBtn.on('pointerdown', function () {

            fillHand(game);

        });
    }

    function rollButton(game)
    {    
        var sprite = game.add.image(0, 0, 'logo').setScale(.1);
        var endBtn = game.add.container(930, 50, [ sprite ]);
            
        endBtn.setSize(sprite.width * .1, sprite.height * .1);

        endBtn.setInteractive();

        endBtn.on('pointerover', function () {

            sprite.setTint(0x7878ff);

        });

        endBtn.on('pointerout', function () {

            sprite.clearTint();

        });

        endBtn.on('pointerdown', function () 
        {
            game.die1.text = Math.floor(Math.random() * 6) + 1;
            game.die2.text = Math.floor(Math.random() * 6) + 1;
            game.die3.text = Math.floor(Math.random() * 6) + 1;
            game.die4.text = Math.floor(Math.random() * 6) + 1;
        });
    }
   
    function getCardInfo(game)
    {

    }

    function boardUpdateRecieve(msg, game)
    {
        var x;
        var y;

        if(msg[0] == 'p')
        {
            x = msg[1];
            y = msg[2];

            var card = game.add.image(0, 0, "MMDeck", msg[3]);
            card.setScale(config.cardS);
            card.angle += -90;

            var set = game.add.container((120 * x) - 40, (79 * y) + 4, [ card ]);

            set.setSize(card.width * config.cardS, card.height * config.cardS);
            set.health = msg[4];

            game.board[x - 2][y - 1] = set;
        }

        if(msg[0] == 'k')
        {
            x = msg[1];
            y = msg[2];

            game.board[x][y].destroy();
            game.board[x][y] = null;
        }
    }

    function boardUpdateSend(gameObject, game, action)
    {
        var x = Math.round((gameObject.x) / 120) - 2;
        var y = Math.round((gameObject.y) / 79) - 1;

        if(action == 'p')
        {
            var msg = action;

            msg += x;
            msg += y;
            msg += gameObject.name;
            msg += gameObject.health;

            game.conn.send(JSON.stringify(msg));
        }

        else if(action == 'k')
        {
            var msg = action;
            msg += x;
            msg += y;
            game.conn.send(JSON.stringify(msg));
        }
    }
    </script>

</body>
</html>